import{u as F,j as e,B as d,a as E,Q as N,A as W,b as I,g as k,U as z,n as O,v as Y,P as T,W as $,X as K,Y as V,i as G,Z as X}from"./mui-CFDhWL5c.js";import{u as q,j as J,a as n,c as Q}from"./vendor-zWPymlFl.js";import{u as U}from"./index-DnHAAhUv.js";import{M as P}from"./MainLayout-B2T8W_MF.js";import{c as A}from"./chatService-RISS4X7f.js";import"./supabase-DTcxSDRM.js";const Z="05HuhddoS0bpO42IaPDvXiWizFtnbP6N",ee="https://api.mistral.ai/v1/chat/completions",H=["I understand you're going through a difficult time. Would you like to talk more about what's troubling you?","It sounds like you're dealing with a lot right now. Remember that it's okay to take things one step at a time.","I'm here to support you through this. What would be most helpful for you right now?","It's brave of you to share your feelings. Have you considered talking to a mental health professional about this?","Deep breathing can sometimes help in moments of stress. Would you like to try a quick breathing exercise?"],b=()=>{const f=Math.floor(Math.random()*H.length);return H[f]},te=async(f,h=[])=>{var i;try{const y=[{role:"system",content:`You are EchoMind, a mental health support assistant.
        Your goal is to provide empathetic, supportive responses to users who may be
        experiencing mental health challenges like depression or anxiety.

        Guidelines:
        - Be empathetic and supportive, but don't try to diagnose
        - Suggest healthy coping strategies when appropriate
        - Encourage professional help for serious concerns
        - Keep responses concise (2-3 paragraphs maximum)
        - Be conversational and warm`},...h,{role:"user",content:f}],r=await fetch(ee,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${Z}`},body:JSON.stringify({model:"mistral-small",messages:y,temperature:.7,top_p:.95,max_tokens:1024})});if(!r.ok)return console.error("Mistral API error:",r.status,r.statusText),b();const o=await r.json();return!o.choices||o.choices.length===0||!((i=o.choices[0].message)!=null&&i.content)?(console.error("Invalid Mistral API response:",o),b()):o.choices[0].message.content}catch(y){return console.error("Error calling Mistral API:",y),b()}},le=()=>{const{supabase:f,session:h}=U(),i=F(),y=q(),{conversationId:r}=J(),[o,C]=n.useState(""),[u,l]=n.useState([]),[p,x]=n.useState(null),[v,m]=n.useState(!1),[S,g]=n.useState(null),M=n.useRef(null),_=()=>{var t;(t=M.current)==null||t.scrollIntoView({behavior:"smooth"})};n.useEffect(()=>{_()},[u]),n.useEffect(()=>{(async()=>{try{if(m(!0),r&&r!=="new"){x(r);try{const c=(await A.getChatMessages(r)).map(a=>({id:a.id,text:a.content,sender:a.role,timestamp:new Date(a.timestamp),session_id:a.session_id}));l(c)}catch(s){console.error("Error loading messages:",s),g("Failed to load conversation messages")}}else try{if(!(h!=null&&h.user))x("placeholder-conversation");else{const s=await A.createChatSession({title:"New Conversation"});x(s.id)}l([{id:"welcome",text:"Hello! How can I help you today?",sender:"assistant",timestamp:new Date,session_id:p||void 0}])}catch(s){console.error("Error creating conversation:",s),g("Failed to create a new conversation"),x("placeholder-conversation"),l([{id:"welcome",text:"Hello! How can I help you today?",sender:"assistant",timestamp:new Date,session_id:"placeholder-conversation"}])}}catch(s){console.error("Error loading chat history:",s),g("Failed to load chat history")}finally{m(!1)}})()},[r,h]);const R=async t=>{if(t.preventDefault(),!o.trim()||!p)return;const s={id:`user-${Date.now()}`,text:o,sender:"user",timestamp:new Date,session_id:p};l(c=>[...c,s]),C(""),m(!0);try{const c=u.slice(-6).map(w=>({role:w.sender==="user"?"user":"assistant",content:w.text})),a=await te(o,c),j={id:`ai-${Date.now()}`,text:a,sender:"assistant",timestamp:new Date,session_id:p};l(w=>[...w,j])}catch(c){console.error("Error in chat:",c);const a={id:`error-${Date.now()}`,text:"Sorry, I encountered an error. Please try again.",sender:"assistant",timestamp:new Date,session_id:p};l(j=>[...j,a]),g("Failed to get response from AI. Please try again.")}finally{m(!1)}},L=async()=>{if(p&&window.confirm("Are you sure you want to clear the chat history? This will delete the current conversation."))try{m(!0),x("placeholder-conversation"),l([{id:"welcome",text:"Hello! How can I help you today?",sender:"assistant",timestamp:new Date,session_id:"placeholder-conversation"}])}catch(t){console.error("Error clearing chat:",t)}finally{m(!1)}},D=()=>{g(null)},B=()=>{y("/chat/history")};return v?e.jsx(P,{children:e.jsx(d,{sx:{display:"flex",justifyContent:"center",alignItems:"center",height:"50vh"},children:e.jsx(E,{size:60})})}):e.jsx(P,{children:e.jsxs(d,{sx:{height:"calc(100vh - 120px)",display:"flex",flexDirection:"column"},children:[e.jsx(N,{open:!!S,autoHideDuration:6e3,onClose:D,anchorOrigin:{vertical:"top",horizontal:"center"},children:e.jsx(W,{onClose:D,severity:"error",sx:{width:"100%"},children:S})}),e.jsxs(d,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2},children:[e.jsx(I,{variant:"h4",component:"h1",children:"Chat Support"}),e.jsxs(d,{sx:{display:"flex",gap:1},children:[e.jsx(k,{variant:"outlined",color:"primary",startIcon:e.jsx(z,{}),onClick:B,title:"View chat history",children:"History"}),e.jsx(O,{color:"error",onClick:L,disabled:u.length===0,title:"Clear chat history",children:e.jsx(Y,{})})]})]}),e.jsx(I,{variant:"body1",color:"text.secondary",paragraph:!0,children:"Talk with our AI assistant for emotional support and guidance."}),e.jsx(T,{elevation:3,sx:{flexGrow:1,mb:2,p:2,overflow:"auto",bgcolor:i.palette.mode==="dark"?"rgba(255, 255, 255, 0.05)":"rgba(0, 0, 0, 0.02)"},children:u.length===0?e.jsx(d,{sx:{height:"100%",display:"flex",flexDirection:"column",justifyContent:"center",alignItems:"center",color:"text.secondary"},children:e.jsx(I,{variant:"body1",align:"center",children:"No messages yet. Start a conversation!"})}):e.jsxs($,{children:[u.map((t,s)=>e.jsxs(Q.Fragment,{children:[e.jsx(K,{alignItems:"flex-start",sx:{flexDirection:t.sender==="user"?"row-reverse":"row",px:1},children:e.jsx(T,{elevation:1,sx:{p:2,maxWidth:"80%",bgcolor:t.sender==="user"?i.palette.primary.main:i.palette.mode==="dark"?"rgba(255, 255, 255, 0.1)":"rgba(0, 0, 0, 0.05)",color:t.sender==="user"?i.palette.primary.contrastText:"text.primary"},children:e.jsx(V,{primary:t.text,secondary:t.timestamp.toLocaleTimeString(),secondaryTypographyProps:{color:t.sender==="user"?"rgba(255, 255, 255, 0.7)":"text.secondary",fontSize:"0.75rem"}})})}),s<u.length-1&&e.jsx(d,{sx:{my:1}})]},t.id)),e.jsx("div",{ref:M})]})}),e.jsxs(d,{component:"form",onSubmit:R,sx:{display:"flex",gap:1},children:[e.jsx(G,{fullWidth:!0,placeholder:"Type your message...",value:o,onChange:t=>C(t.target.value),disabled:v,variant:"outlined",size:"medium",autoComplete:"off"}),e.jsx(k,{type:"submit",variant:"contained",color:"primary",disabled:!o.trim()||v,sx:{minWidth:"100px"},endIcon:v?e.jsx(E,{size:20,color:"inherit"}):e.jsx(X,{}),children:"Send"})]})]})})};export{le as default};
//# sourceMappingURL=Chat-QUk2HXLM.js.map
